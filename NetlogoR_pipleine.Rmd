---
title: "Netlogo to R Pipeline"
author: "Shannon Carter"
date: "March 11, 2019"
output: html_document
---

The goal here is to make a clean reproducible pipeline to transform Netlogo output into a tidy rectangular dataframe. Here, I import behavior space data (i.e., experiment results) from Netlogo to R. Netlogo's behavior space data comes in a wonky format, and the goal is to do as much of the tidying in R (vs. on spreadsheet) as possible. The data I've imported here does several 'runs' (multiple treatments and replicates) of an simulation testing effects of phenology on species interactions. There is summary data for each run and there's also time series info on size for each turtle/agent.

```{r setup, include = F}
knitr::opts_chunk$set(echo = T, warning = F)

## Set working directory and clear memory
setwd("C:\\Users\\Shannon\\Desktop\\GitHub Repos\\phenology-abm")
rm(list = ls(all = T))

## Load required packages
library(tidyverse)
library(reshape2)
library(RColorBrewer)
library(lme4)
#library(RNetLogo)    # maybe worthwhile looking into this, so far can't figure it out

## Load universal plotting elements
mytheme <- theme(panel.background = element_blank(),
                 panel.grid.minor = element_blank(), 
                 panel.grid.major = element_blank(),
                 axis.text  = element_text(size = rel(1.3), colour = "black"),
                 axis.title = element_text(size = rel(2.0)),
                 axis.line  = element_line(colour = "black"))

```

First, be sure you export behavior space data in "table" format. When the raw data is exported as a spreadsheet, it comes in a really gnarly format. R can't read it because it's not even close to rectangular, big header, mix of space delimited and bracket delimited. It's a mess. The table is still a bit messy, but much easier to wrangle.

```{r load table data}

test <- read.table("bs1_table2.csv",
                   header = T,
                   sep = ',',
                   skip = 6,         # 6 header rows we don't need
                   quote = "\"",
                   fill = T)         # add blank fields if rows have unequal length

# [,1:12] are parameter values (some consistent across all, some representing trts)
# [,13:16] are the output we designated
str(test)  

```

First, let's rename columns and drop some that we don't need. I keep some columns that are the same across all model runs because it will be useful to call them later, especially since different runs of the experiment might have differetn values. Some columns will always be the same, or are irrelevant. These I drop. 
```{r}
# select and rename columns. new_name = old name. 
# renaming everything I keep, so can rename with select
test <- test %>% 
  select(run_num = X.run.number.,
         total_time = X.step.,
         n_fish = n.fishes,
         n_dfly = n.dflies,
         sync_dfly = var.hatch.dflies,   
         mean_dfly = mean.hatch.dflies, 
         surv_dfly = n.meta.dflies,
         sync_fish = var.hatch.fishes, 
         surv_fish = n.meta.fishes, 
         sizes_dfly = X.dfly.size.list..of.dflies, 
         sizes_fish = X.fish.size.list..of.fishes)

# extract and keep this for reference-- will need it for rejoining data with params later
params <- test[,1:9]
```

The 'sizes' columns has a time series of size for each individual. Let's separate that. This warning is ok. The last individual ends with double closed bracket, so we're just deleting that extra bracket, and still end up with the 50 individuals for each species that we expect.
```{r}
test <- test %>% 
  separate(sizes_dfly,                                      # separate sizes_dfly
           into = paste("d_", c(1:test$n_dfly), sep = ""),  # levels for new var
           sep = "]") %>%                                   # every ] marks a new ind
  separate(sizes_fish, 
           into = paste("f_", c(1:test$n_fish), sep = ""), 
           sep = "]")
```

Now, gather it so that individuals appear in rows instead of columns. Need to separate species here, otherwise we'll end up with nfish x dfly x ntreatment rows
```{r}
## FIRST DRAGONFLIES 

# select only unique dfly individuals and gather to long format
test_dfly <- test %>%
  select(run_num, d_1:d_50) %>% 
  unique(.) %>% 
  gather(d_1:d_50, key = "dfly_id", value = 'size_dfly') %>% 
  arrange(run_num)

# remove the brackets
test_dfly$size_dfly <- gsub("[", "", test_dfly$size_dfly, fixed = T)

# separate the size time series- each space represents a new time point
test_dfly <- test_dfly %>% 
  separate(size_dfly, into = as.character(c(0:149)), sep = " ") %>% 
  select(-c(as.character(0)))

# gather to long format, so we now have one line per dfly per time step
test_dfly <- test_dfly %>% 
  group_by(run_num) %>% 
  gather(as.character(1:149), key = "time", value = 'current_size_dfly') %>%
  arrange(run_num, dfly_id)

## NEXT, FISH

# select only unique fish individuals and gather to long format
test_fish <- test %>%
  select(run_num, f_1:f_50) %>% 
  unique(.) %>% 
  gather(f_1:f_50, key = "fish_id", value = 'size_fish') %>% 
  arrange(run_num)

# remove the brackets
test_fish$size_fish <- gsub("[", "", test_fish$size_fish, fixed = T)

# separate the size time series- each space represents a new time point
test_fish <- test_fish %>% 
  separate(size_fish, into = as.character(c(0:149)), sep = " ") %>% 
  select(-c(as.character(0)))

# gather to long format, so we now have one line per dfly per time step
test_fish <- test_fish %>% 
  group_by(run_num) %>% 
  gather(as.character(1:149), key = "time", value = 'current_size_fish') %>%
  arrange(run_num, fish_id)

```

Now, join the dataframes together and rejoin with the treatment information.
```{r}
test <- cbind(test_dfly, test_fish)
test <- test %>% 
  select(-c(run_num1, time1)) 
test$dfly <- paste(test$dfly_id, test$current_size_dfly)
test$fish <- paste(test$fish_id, test$current_size_fish)
test1 <- test %>% 
  select(run_num, time, dfly, fish)
test2 <- test1 %>% 
  gather(key = "species", "size", dfly, fish)
test2$time <- as.numeric(test2$time)
test2 <- test2 %>% 
  separate(size, into = c("id", "size"), sep = " ") %>% 
  separate(id, into = c("sp", "id"), sep = "_") %>% 
  select(-sp) %>% 
  arrange(run_num, id, time)

test <- left_join(test2, params, by = "run_num")
test <- test %>%
  select(run_num, n_fish, n_dfly, sync_fish, sync_dfly, mean_dfly,
         surv_fish, surv_dfly, time, species,
         id, size)


```


```{r}
plot <- ggplot(data = test, aes(x = time, y = size, color = species)) + 
  geom_smooth() +
  facet_grid(sync_dfly ~ mean_dfly)
plot

plot1 <- ggplot(test, aes(x = mean_dfly, y = surv_dfly))
```

