---
title: "Netlogo to R Pipeline"
author: "Shannon Carter"
date: "March 11, 2019"
output: 
  html_document:
  theme: united
---

The goal here is to make a clean reproducible pipeline to transform Netlogo output into a tidy rectangular dataframe. Here, I import behavior space data (i.e., experiment results) from Netlogo to R. Netlogo's behavior space data comes in a wonky format, and the goal is to do all tidying in R (vs. on spreadsheet) so it's easy to feed through new data. The data I've imported here does several 'runs' (multiple treatments and replicates) of an simulation testing effects of phenology on species interactions. There is summary data for each run and there's also time series info on size for each turtle/agent.

```{r setup, include = F}
knitr::opts_chunk$set(echo = T, warning = F)

## Set working directory and clear memory
setwd("C:\\Users\\Shannon\\Desktop\\GitHub Repos\\phenology-abm")
rm(list = ls(all = T))

## Load required packages
library(tidyverse)
library(reshape2)
library(RColorBrewer)
library(lme4)
#library(RNetLogo)    # maybe worthwhile looking into this, so far can't figure it out

## Load universal plotting elements
mytheme <- theme(panel.background = element_blank(),
                 panel.grid.minor = element_blank(), 
                 panel.grid.major = element_blank(),
                 axis.text  = element_text(size = rel(1.3), colour = "black"),
                 axis.title = element_text(size = rel(2.0)),
                 axis.line  = element_line(colour = "black"))

```

## Import Data

First, be sure you export behavior space data from Netlogo in "table" format. When the raw data is exported as a spreadsheet, it comes in a really gnarly format. R can't read it because it's not even close to rectangular, big header, mix of space delimited and bracket delimited. It's a mess. The table is still a bit messy, but much easier to wrangle.

```{r load table data}

test <- read.table("bs1_table2.csv",
                   header = T,  
                   sep = ',',        # define the separator between columns
                   skip = 6,         # 6 header rows we don't need
                   quote = "\"",     # correct the column separator
                   fill = T)         # add blank fields if rows have unequal length

# [,1:12] are parameter values (some consistent across all, some representing trts)
# [,13:ncol] are the output we designated
str(test)  

```

# Select & Rename Variables

First, let's rename columns and drop some that we don't need. I keep some columns that are the same across all model runs because it will be useful to call them later, especially since different runs of the experiment might have differetn values. Some columns will always be the same, or are irrelevant. These I drop. 
```{r}
# select and rename columns. new_name = old name. 
# renaming everything I keep, so can rename with select
test <- test %>% 
  select(run_num = X.run.number.,
         total_time = X.step.,
         n_fish = n.fishes,
         n_dfly = n.dflies,
         sync_dfly = var.hatch.dflies,   
         mean_dfly = mean.hatch.dflies, 
         surv_dfly = n.meta.dflies,
         sync_fish = var.hatch.fishes, 
         surv_fish = n.meta.fishes, 
         sizes_dfly = X.dfly.size.list..of.dflies, 
         sizes_fish = X.fish.size.list..of.fishes)

# extract parameter values-- will need it for rejoining data with params later
params <- test[,1:9]
```

# Parse Individuals

The 'sizes_x' columns have a time series of size for each individual (so each sizes_ column has 50 individuals x 150 time steps values). We ultimately want one row per individual per time step. Let's first separate by individual. 

```{r}

# first, separate so that each individual has it's own column
test <- test %>% 
  separate(sizes_dfly,                                      # separate sizes_dfly
           into = paste("d_", c(1:test$n_dfly), sep = ""),  # levels for new var
           sep = "]") %>%                                   # every ] marks a new ind
  separate(sizes_fish, 
           into = paste("f_", c(1:test$n_fish), sep = ""), 
           sep = "]")

# next, I'll gather individuals so that they appear in rows
# I separate this step by species because it's easier for me to catch errors

## FIRST, DRAGONFLIES 
# select only unique dfly individuals and gather to long format
test_dfly <- test %>%
  select(run_num, d_1:d_50) %>% 
  unique(.) %>% 
  gather(d_1:d_50, key = "dfly_id", value = 'size_dfly') %>% 
  arrange(run_num)

# remove the brackets
test_dfly$size_dfly <- gsub("[", "", test_dfly$size_dfly, fixed = T)

## NEXT, FISH
# select only unique fish individuals and gather to long format
test_fish <- test %>%
  select(run_num, f_1:f_50) %>% 
  unique(.) %>% 
  gather(f_1:f_50, key = "fish_id", value = 'size_fish') %>% 
  arrange(run_num)

# remove the brackets
test_fish$size_fish <- gsub("[", "", test_fish$size_fish, fixed = T)
```

# Parse Time Series

Now, do the same separate and gather operations to parse the time vector and put in long format.

```{r}

## FIRST, DRAGONFLIES 
# separate the size time series- each space represents a new time point
test_dfly <- test_dfly %>% 
  separate(size_dfly, into = as.character(c(0:149)), sep = " ") %>% 
  select(-c(as.character(0))) # I drop this because there's only a value for ind 1

# gather to long format, so we now have one line per dfly per time step
test_dfly <- test_dfly %>% 
  group_by(run_num) %>% 
  gather(as.character(1:149), key = "time", value = 'current_size_dfly') %>%
  arrange(run_num, dfly_id)

## NEXT, FISH
# separate the size time series- each space represents a new time point
test_fish <- test_fish %>% 
  separate(size_fish, into = as.character(c(0:149)), sep = " ") %>% 
  select(-c(as.character(0))) # I drop this because there's only a value for ind 1

# gather to long format, so we now have one line per dfly per time step
test_fish <- test_fish %>% 
  group_by(run_num) %>% 
  gather(as.character(1:149), key = "time", value = 'current_size_fish') %>%
  arrange(run_num, fish_id)

```

# Compile & Tidy

Now, join the 2 species' dataframes together, rejoin with the treatment information, and write a csv. This csv has 1 line per individual per time step. So nrow should be max(run_num) x (ndfly + nfish) x total_time
```{r}

# paste dfs together and remove redundant variables
test <- cbind(test_dfly, test_fish)
test <- test %>% 
  select(-c(run_num1, time1)) 

# this is clunkier than it needs to be, but allows some double checking
test$dfly <- paste(test$dfly_id, test$current_size_dfly)
test$fish <- paste(test$fish_id, test$current_size_fish)
test1 <- test %>% 
  select(run_num, time, dfly, fish)
test2 <- test1 %>% 
  gather(key = "species", "size", dfly, fish)
test2$time <- as.numeric(test2$time)

test2 <- test2 %>% 
  separate(size, into = c("id", "size"), sep = " ") %>% 
  separate(id, into = c("sp", "id"), sep = "_") %>% 
  select(-sp) %>% 
  arrange(run_num, id, time)
test2$size <- as.numeric(test2$size)

# rejoin with treatment identifiers for each run number
test <- left_join(test2, params, by = "run_num")
ind_time <- test %>%
  select(run_num, n_fish, n_dfly, sync_fish, sync_dfly, mean_dfly,
         surv_fish, surv_dfly, time, species,
         id, size)

write.csv(ind_time, "individual_time.csv")

```


## Summarize by Individual

Now, I want to make some summarised datasets. First with one row per individual, then with one row per run number 

```{r}
ind_time <- read.csv("individual_time.csv", header = T)

ind <- ind_time %>% 
  group_by(run_num, species, id, sync_fish, sync_dfly, mean_dfly, surv_dfly, surv_fish) %>%
  summarise(max_size = max(size),
            meta = if_else(max_size >= 10, 1, 0),
            hatch_date = min(time[size > 0]),
            # use base R ifelse here, so we can have 2 data types for T/F
            meta_date = ifelse(meta == 1, min(time[size >= 10]), NA), 
            death_date = ifelse(meta == 0, min(time[size = max(max_size)]), NA),
            growth_time = meta_date - hatch_date)

# currently, number of metamorphs doesn't match raw data. think it might be a >= mismatch. check.
check <- ind %>% 
  group_by(run_num, species, surv_dfly, surv_fish) %>%
  summarise(no_meta = sum(meta))
ggplot(subset(check, subset = (species == "fish")), aes(x = surv_fish, y = no_meta)) +
  geom_point() + theme_bw() +
  geom_abline(slope = 1, intercept = 0)

```
## Summarize by Treatment
```{r}
View(params)
trt <- params %>% 
  group_by(sync_dfly, mean_dfly) %>% 
  summarise(mean_surv_dfly = mean(surv_dfly),
            mean_surv_fish = mean(surv_fish),
            se_surv_dfly   = sd(surv_dfly)/sqrt(length(surv_dfly)),
            se_surv_fish   = sd(surv_fish)/sqrt(length(surv_fish)))
ggplot(trt, aes(x = mean_dfly, y = mean_surv_dfly, color = as.factor(sync_dfly))) +
  geom_point() + 
  geom_errorbar(width = 0,
    aes(max = mean_surv_dfly + se_surv_dfly, 
        min = mean_surv_dfly - se_surv_dfly))
```

## Plots
need to adjust all the data frames, but some plot ideas to add at the end of the pipeline for diagnostics
```{r}
###---2. Linear growth---------------------------------------
test7long$cohort <- as.factor(test7long$cohort)
plot2 <- ggplot(test7long, aes(x = tick, y = size, group=interaction(cohort,turt), color = cohort)) + 
  geom_point(size = 1, alpha = 0.2) + 
  stat_smooth(alpha = 0.1, se = F, size = 1, method = "lm") + 
  facet_grid(dens ~ sync, scales = 'free') + mytheme 
plot2

###---3. Final size by hatch tick-----------------------------
plot3 <- ggplot(test7sum, aes(x = hatch_tick, y = maxsize)) +
  geom_point(size = 1, alpha = 0.2, position = 'jitter') +
  stat_smooth(method = 'lm', se = T, size = 2) +
  facet_grid(dens ~ sync, scales = 'free') + mytheme
plot3

###---4. Survival probability plots---------------------------
plot4 <- ggplot(test7sum, aes(x = hatch_tick, y = meta)) + 
  geom_point(alpha = 0.25) + 
  stat_smooth(method = 'glm', method.args = 'binomial') +
  facet_grid(density ~ synchrony, scales = "free") + 
  xlab("hatch date") + ylab("probability of survival") +
  theme(strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14)) +
  mytheme
plot4

###---5. N_meta by treatment--------------------------------------

test8supersum$density <- as.factor(test8supersum$dens)
test7supersum$density <- factor(test7supersum$density, levels = c('low density', 'med density', 'high density'))

plot5 <- ggplot(test7supersum, aes(x = sync, y = prop_surv - min_surv, color = density)) + mytheme +
  geom_jitter(width = 0.25, size = 4) + 
  stat_smooth(size = 4, method = "lm", se = T, aes(x = sync, fill = density)) +
  xlab("synchrony") + ylab("proportion survivors (relative to sync = 1)") #+
  #theme(legend.position = "none") 
plot5

# Med density only
plot5 <- ggplot(subset(test7supersum, subset = (dens == 80)), aes(x = sync, y = prop_surv)) + mytheme +
  geom_jitter(width = 0.25, size = 4, color = "springgreen4", alpha = 0.25) + 
  stat_smooth(size = 4, color = 'springgreen4', fill = 'springgreen4', method = "lm", se = T) +
  xlab("synchrony") + ylab("proportion survivors") +
  theme(axis.text.x = element_blank())
plot5


plot5a <- ggplot(test7supersum, aes(x = sync, y = prop_surv, color = density)) + mytheme +
  geom_point(size = 3) + 
  stat_smooth(size = 2, method = 'lm', se = T, aes(x = sync, fill = density)) #+
  facet_grid(dens ~ ., scales = 'free')
plot5a

plot5x <- ggplot(test8supersum, aes(x = dens, y = n_meta/dens, color = as.factor(sync))) +# mytheme +
  geom_point() +
  stat_smooth(size = 2, se = F)
plot5x

###---6. Synchrony across stages-----------------------------

## Subset to include only individuals that metamorphed
test7surv <- subset(test7sum, subset = (meta == 1))

## Original hatching and metamorph
plot6 <- ggplot(test7sum, aes(hatch_adj)) + mytheme +
  # gray: original/imposed hatching synchrony
  geom_density(size = 1.5, alpha = 0.25, fill = "black", color = "gray39", linetype = "dashed") + 
  # blue: metamorphosis dates of survivors, scaled to day 0
  geom_density(data = test7sum, size = 1.5, alpha = 0.5, color = "steelblue4", fill = "steelblue4",
               aes(x = meta_adj)) +
  facet_grid(density ~ synchrony , scales = "free_y") + 
  xlab("date") + ylab("proportion") +
  theme(strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14)) 
plot6

## Original hatching and hatching of survivors
plot6b <- ggplot(test7sum, aes(hatch_adj)) + mytheme +
  # gray: original/imposed hatching synchrony
  geom_density(size = 1.5, alpha = 0.25, fill = "black", color = "gray39", linetype = "dashed") + 
  # blue: hatching dates of survivors
  geom_density(data = test7surv, size = 1.5, alpha = 0.5, color = "steelblue4", fill = "steelblue4",
               aes(x = hatch_adj)) +
  facet_grid(density ~ synchrony, scales = "free_y") + 
  xlab("date") + ylab("proportion") +
  theme(strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14))
plot6b 

## original hatching, survival hatching and metamorph
plot6c <- ggplot(test7sum, aes(hatch_adj)) + mytheme +
  # gray: original/imposed hatching synchrony
  geom_density(size = 1.5, alpha = 0.25, fill = "black", color = "gray39", linetype = "dashed") + 
  # blue: hatching dates of the ones that survived and metamorphed
  #geom_density(data = test7surv, size = 1.5, alpha = 0.5, color = "steelblue4", fill = "steelblue4",
  #              aes(x = hatch_adj)) +
  # red: the date of metamorphosis for survivors
  geom_density(data = test7sum, size = 1.5, alpha = 0.5, color = "tomato4", fill = "tomato4",
               aes(x = meta_adj + 5)) +
  facet_wrap(density ~ synchrony, scales = "free_y") +
  xlab("days after first individual") + ylab("proportion of individuals") +
  theme(strip.background = element_blank(),
        strip.text = element_blank(),
        axis.text.y = element_blank())
plot6c 

## Synchrony treatments - for methods in ppt
plot6x <- ggplot(test7sum, aes(hatch_tick, color = synchrony)) + mytheme +
  geom_density(adjust = 2, size = 3, alpha = 0.25) +
  xlab("hatch date") + ylab("proportion") +
  theme(legend.position = "none",
        axis.title = element_text(size = rel(1.25))) +
  scale_color_manual(values = c("black", "black", "black", "black"))
plot6x

## Single synchrony trts - for methods in ppt
plot6xa <- ggplot(subset(test7sum, sync == 7), aes(hatch_tick)) + mytheme +
  geom_density(adjust = 2, size = 2, alpha = 0.25) +
  xlab("hatch date") + ylab("proportion of individuals") +
  theme(legend.position = "none",
        axis.title = element_text(size = rel(1.25)))
plot6xa

###---7. Growth rates by hatch date---------------------------------
z <- subset(test7sum, subset = (rep == 3))  ## resource starts at 20, but ~50% survival even if they beat resource by 6 days
plot7 <- ggplot(z, aes(x = hatch_tick, y = growthrate)) + 
  geom_point(alpha = 0.65, size = 2, aes(color = as.factor(meta))) +
  stat_smooth(method = "lm", formula = y ~ poly(x, 2), se = T, size = 2, color = "gray39") +
  facet_grid(density ~ synchrony, scales = "free") + mytheme +
  theme(legend.position = "none",
        strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14)) +
  xlab("hatch date") + ylab("growth rate")
plot7

###---8. Growth rates variation-------------------------------------
plot8 <- ggplot(subset(test7sum, meta == 1), aes(x = growthrate, color = synchrony)) + mytheme +
  geom_density(size = 2) + 
  facet_grid(density ~ .) +
  xlab("growth rate") + ylab("proportion")
plot8

###---9. Probability of metamorphing-------------------------------- 
plot9 <- ggplot(test7sum, aes(x = hatch_tick, y = meta, color = as.factor(dens))) +
  geom_point(alpha = 0.25) + mytheme +
  stat_smooth(method = 'glm', method.args = 'binomial', size = 2, alpha = 0.5, se = F) +
  facet_wrap(~sync)
plot9                  


```

